<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Goat Training Capture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #1a1a2e;
        color: white;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Login Screen */
      #login {
        text-align: center;
        padding: 20px;
      }
      #login h1 {
        font-size: 24px;
        margin-bottom: 30px;
        color: #eee;
      }
      #login input {
        padding: 15px 20px;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        width: 250px;
        margin-bottom: 15px;
      }
      #login button {
        padding: 15px 40px;
        font-size: 18px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }
      #login button:hover {
        background: #45a049;
      }

      /* Main App */
      #app {
        display: none;
        text-align: center;
        padding: 20px;
        width: 100%;
        max-width: 400px;
      }

      .counter {
        font-size: 120px;
        font-weight: bold;
        color: #4caf50;
        margin: 20px 0;
      }

      .label {
        font-size: 18px;
        color: #888;
        margin-bottom: 40px;
      }

      .record-btn {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: none;
        background: #e53935;
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 8px 30px rgba(229, 57, 53, 0.4);
        transition: all 0.2s;
      }
      .record-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 40px rgba(229, 57, 53, 0.5);
      }
      .record-btn:disabled {
        background: #666;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      .record-btn.recording {
        background: #ff9800;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .status {
        margin-top: 30px;
        font-size: 16px;
        color: #888;
        min-height: 24px;
      }
      .status.error {
        color: #e53935;
      }
      .status.success {
        color: #4caf50;
      }

      .logout {
        position: fixed;
        top: 20px;
        right: 20px;
        background: none;
        border: 1px solid #444;
        color: #666;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .logout:hover {
        border-color: #666;
        color: #888;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="login">
      <h1>Goat Training Capture</h1>
      <input
        type="password"
        id="pw"
        placeholder="Password"
        onkeypress="if (event.key === 'Enter') checkPw();"
      />
      <br />
      <button onclick="checkPw()">Enter</button>
    </div>

    <!-- Main App -->
    <div id="app">
      <button class="logout" onclick="logout()">Logout</button>

      <div class="label">GOAT NUMBER</div>
      <div class="counter" id="counter">1</div>

      <button class="record-btn" id="recordBtn" onclick="startRecording()">
        RECORD
      </button>

      <div class="status" id="status"></div>
    </div>

    <script>
      const PASS_HASH = "3af55a6ff02e8fa254bc70865d816394";
      const API_BASE = "http://100.110.194.126:5001";

      let goatId = parseInt(localStorage.getItem("goatId") || "1");
      let isRecording = false;

      // Auth functions
      function checkPw() {
        const input = document.getElementById("pw").value;
        if (md5(input) === PASS_HASH) {
          localStorage.setItem("auth", "true");
          showApp();
        } else {
          alert("Wrong password");
        }
      }

      function logout() {
        localStorage.removeItem("auth");
        location.reload();
      }

      function showApp() {
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        updateCounter();
      }

      // Recording functions
      function updateCounter() {
        document.getElementById("counter").textContent = goatId;
        localStorage.setItem("goatId", goatId.toString());
      }

      async function startRecording() {
        if (isRecording) return;

        const btn = document.getElementById("recordBtn");
        const status = document.getElementById("status");

        isRecording = true;
        btn.disabled = true;
        btn.classList.add("recording");
        btn.textContent = "RECORDING...";
        status.textContent = "Recording goat #" + goatId + "...";
        status.className = "status";

        try {
          // Start recording
          const response = await fetch(API_BASE + "/record", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ goat_id: goatId, duration: 5 }),
          });

          if (!response.ok) {
            throw new Error("Failed to start recording");
          }

          // Poll for completion
          await pollStatus();

          // Success - increment counter
          status.textContent = "✓ Goat #" + goatId + " recorded!";
          status.className = "status success";
          goatId++;
          updateCounter();
        } catch (err) {
          status.textContent = "✗ Error: " + err.message;
          status.className = "status error";
        } finally {
          isRecording = false;
          btn.disabled = false;
          btn.classList.remove("recording");
          btn.textContent = "RECORD";
        }
      }

      async function pollStatus() {
        const maxAttempts = 30;
        for (let i = 0; i < maxAttempts; i++) {
          await sleep(500);

          const response = await fetch(API_BASE + "/status");
          const data = await response.json();

          if (!data.active) {
            if (data.last_error) {
              throw new Error(data.last_error);
            }
            if (data.last_result && !data.last_result.success) {
              throw new Error(
                data.last_result.errors?.join(", ") || "Recording failed",
              );
            }
            return; // Success
          }
        }
        throw new Error("Recording timed out");
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // Init
      if (localStorage.getItem("auth") === "true") {
        showApp();
      }
    </script>
  </body>
</html>

<!-- Test 1 -->
