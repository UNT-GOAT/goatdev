- name: Deploy to Pi
  env:
    SSH_PRIVATE_KEY: ${{ secrets.PI_SSH_PRIVATE_KEY }}
    TAILSCALE_IP: ${{ secrets.TAILSCALE_IP }}
  run: |
    mkdir -p ~/.ssh
    echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
    chmod 600 ~/.ssh/deploy_key
    ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no pi@${TAILSCALE_IP} << 'EOF'
      set -e
      cd /home/pi/goat-capture
      git pull origin main
      
      # Create venv if doesn't exist
      if [ ! -d "/home/pi/venv" ]; then
        python3 -m venv /home/pi/venv
      fi
      
      source /home/pi/venv/bin/activate
      pip install -r pi/requirements.txt --quiet
      
      # Restart services
      sudo systemctl restart goat-capture
      sudo systemctl restart goat-training
      
      echo "Deployed and restarted at $(date)"
      git log -1 --oneline
    EOF
